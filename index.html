<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI旅のおともプロトタイプ</title>
  <style>
    video {
      width: 100%;
      border-radius: 12px;
    }
    button {
      padding: 10px 20px;
      margin-right: 10px;
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .start-btn { background-color: #3b82f6; }
    .send-btn { background-color: #10b981; }
  </style>
</head>
<body>
  <h1>AI旅のおともプロトタイプ（Vanilla JS版）</h1>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display: none;"></canvas>
  <div>
    <button class="start-btn" onclick="startCamera()">カメラ開始</button>
    <button class="send-btn" onclick="captureAndSendToAI()">景色を送る</button>
    <button onclick="speak('こんにちは。聞こえますか？')">音声テスト</button>
  </div>
  <p id="response"></p>

  <script>
  const API_URL = 'http://localhost:3000/vision';
  const video   = document.getElementById('video');
  const canvas  = document.getElementById('canvas');
  const respEl  = document.getElementById('response');

  async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    video.srcObject = stream;
  }

  async function captureAndSendToAI() {
    /* 1. フレームを canvas に描画 */
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

    /* 2. canvas → Blob → Base64 */
    const blob         = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.8));
    const base64Image  = await blobToBase64(blob);             // ← ここで作成
    console.log('[debug] base64 size', base64Image.length);

    /* 3. OpenAI へ送信 */
    const data = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body:   JSON.stringify({ imageBase64: base64Image })      // ← 変数名を合わせる
    }).then(r => r.json());

    /* 4. 返答を表示＆読み上げ */
    respEl.textContent = data.answer || '応答がありません';
    speak(data.answer || '応答がありません');
  }

  function blobToBase64(blob) {
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  }

  function speak(text) {
    speechSynthesis.cancel();
    const uttr = new SpeechSynthesisUtterance(text);
    speechSynthesis.speak(uttr);
  }
  </script>
</body>
</html>
