<!DOCTYPE html>
<html lang="ja" class="h-full touch-manipulation select-none">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>AIæ—…ã®ãŠã¨ã‚‚</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="dark light">
  <style>
    :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
    html, body { background: #0a0a0a; }
    #preview { width:100vw; height:100dvh; object-fit:cover; background:black; }
    @keyframes fadeAway { 0%{opacity:1} 70%{opacity:.3} 100%{opacity:0} }
    .fade-out { animation: fadeAway 3.6s ease forwards; }
    .sheet { transition: transform .26s ease, opacity .26s ease }
    * { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body class="h-full text-zinc-100">

  <!-- ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®ã‚«ãƒ¡ãƒ©è¡¨ç¤º -->
  <main id="stage" class="fixed inset-0 overflow-hidden">
    <video id="preview" playsinline autoplay muted></video>

    <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ç¾¤ -->
    <div id="chrome" class="absolute inset-0 z-20 flex flex-col justify-between p-3 md:p-4 opacity-100 transition-opacity duration-200">
      <!-- Top bar -->
      <div class="flex items-center justify-between pt-[var(--safe-top)]">
        <!-- å·¦å´ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div class="inline-flex items-center gap-2 px-2.5 py-1.5 rounded-xl bg-black/40 ring-1 ring-white/10 backdrop-blur">
          <span id="status-led" class="inline-block w-2.5 h-2.5 rounded-full bg-zinc-500"></span>
          <span id="status-text" class="text-sm text-zinc-200">å¾…æ©Ÿä¸­</span>
        </div>
        
        <!-- å³å´ï¼šéŸ³å£°ãƒœã‚¿ãƒ³ã¨RECãƒãƒƒã‚¸ -->
        <div class="flex items-center gap-2">
          <button id="btn-sound" class="inline-flex items-center justify-center w-10 h-10 rounded-xl bg-black/40 ring-1 ring-white/10 backdrop-blur hover:bg-black/60 transition">
            <span class="text-lg">ğŸ”Š</span>
          </button>
          <span id="badge-rec" class="hidden px-2 py-1 text-xs rounded-md bg-red-600/80">REC</span>
        </div>
      </div>

      <!-- å³ä¸Š: ãƒãƒ£ãƒƒãƒˆ -->
      <div class="absolute right-3 top-16 md:right-4 md:top-20 max-w-[80vw] sm:max-w-[60vw] space-y-1">
        <div id="chat" class="flex flex-col gap-1"></div>
      </div>

      <!-- Bottom controls -->
      <div class="grid grid-cols-3 items-end gap-3 pb-[calc(8px+var(--safe-bottom))]">
        <div class="flex items-center">
          <button id="btn-switch" class="ml-1 inline-flex items-center justify-center w-12 h-12 rounded-full bg-black/40 ring-1 ring-white/10 backdrop-blur hover:bg-black/55" aria-label="ã‚«ãƒ¡ãƒ©åˆ‡æ›¿">ğŸ”„</button>
        </div>
        <div class="flex items-center justify-center">
          <button id="btn-shutter" class="relative w-20 h-20 rounded-full bg-amber-500 shadow-[0_0_0_6px_rgba(255,255,255,0.18)] active:scale-95 transition" aria-label="æ’®å½±/é€ä¿¡">
            <span class="absolute inset-1 rounded-full bg-amber-600/70"></span>
          </button>
        </div>
        <div class="flex items-center justify-end">
          <button id="btn-more" class="mr-1 inline-flex items-center justify-center w-12 h-12 rounded-full bg-black/40 ring-1 ring-white/10 backdrop-blur" aria-label="ãã®ä»–">â‹¯</button>
        </div>
      </div>
    </div>

    <!-- ç”»é¢ã‚¿ãƒƒãƒ—ã§UIè¡¨ç¤º/éš ã™ -->
    <button id="hitbox" class="absolute inset-0 z-10 bg-transparent" aria-label="UIè¡¨ç¤ºåˆ‡æ›¿"></button>

    <!-- æ’®å½±ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ -->
    <div id="flash" class="hidden absolute inset-0 bg-white/80 pointer-events-none z-50"></div>

    <!-- ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆ -->
    <div id="sheet" class="sheet fixed left-0 right-0 bottom-0 z-30 translate-y-full opacity-0 pointer-events-none">
      <div class="mx-auto max-w-screen-sm rounded-t-3xl bg-zinc-950/95 ring-1 ring-white/10 backdrop-blur p-4 pb-[calc(12px+var(--safe-bottom))] shadow-2xl">
        <div class="mx-auto mb-3 h-1 w-10 rounded-full bg-white/15"></div>
        <div class="flex items-center justify-between mb-3">
          <div class="text-sm text-zinc-300">è©³ç´°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</div>
          <button id="btn-close-sheet" class="px-3 py-1.5 rounded-lg bg-zinc-800 hover:bg-zinc-700">é–‰ã˜ã‚‹</button>
        </div>
        <div class="space-y-3">
          <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ› -->
          <div class="flex items-center gap-2">
            <input id="userText" type="text" placeholder="è³ªå•ã‚’å…¥åŠ›..." 
              class="flex-1 px-3 py-2 rounded-xl bg-zinc-900 ring-1 ring-white/10 text-white placeholder:text-zinc-500">
            <button id="btn-send-text" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500">é€ä¿¡</button>
          </div>
          
          <!-- ã‚¯ã‚¤ãƒƒã‚¯è³ªå• -->
          <div class="grid grid-cols-2 gap-2">
            <button onclick="quickQuestion('ã“ã‚Œã¯ä½•ã§ã™ã‹ï¼Ÿ')" 
              class="h-10 rounded-lg bg-zinc-800 hover:bg-zinc-700 text-sm">ã“ã‚Œã¯ä½•ï¼Ÿ</button>
            <button onclick="quickQuestion('è©³ã—ãæ•™ãˆã¦')" 
              class="h-10 rounded-lg bg-zinc-800 hover:bg-zinc-700 text-sm">è©³ã—ãæ•™ãˆã¦</button>
            <button onclick="quickQuestion('æ­´å²ã‚’æ•™ãˆã¦')" 
              class="h-10 rounded-lg bg-zinc-800 hover:bg-zinc-700 text-sm">æ­´å²ã«ã¤ã„ã¦</button>
            <button onclick="quickQuestion('ãŠã™ã™ã‚ã¯ï¼Ÿ')" 
              class="h-10 rounded-lg bg-zinc-800 hover:bg-zinc-700 text-sm">ãŠã™ã™ã‚ã¯ï¼Ÿ</button>
          </div>
          
          <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="grid grid-cols-2 gap-3">
            <button id="btn-capture" class="h-11 rounded-xl bg-amber-600 hover:bg-amber-500 font-medium">ğŸ“¸ ç”»åƒé€ä¿¡</button>
            <button id="btn-rec" class="h-11 rounded-xl bg-rose-700 hover:bg-rose-600 font-medium">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
          </div>
          
          <!-- ã‚«ãƒ¡ãƒ©è¨­å®š -->
          <div class="flex items-center gap-3">
            <button id="btn-start" class="flex-1 h-11 rounded-xl bg-emerald-600 hover:bg-emerald-500 font-medium">ã‚«ãƒ¡ãƒ©èµ·å‹•</button>
            <button id="btn-reset" class="flex-1 h-11 rounded-xl bg-zinc-800 hover:bg-zinc-700">ä¼šè©±ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden canvas -->
    <canvas id="canvas" class="hidden"></canvas>
  </main>

  <!-- UIåˆ¶å¾¡ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    const $ = (id) => document.getElementById(id);
    const chrome = $('chrome');
    const hitbox = $('hitbox');
    const flash = $('flash');
    const sheet = $('sheet');

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    const setStatus = (text, live=false) => {
      $('status-text').textContent = text;
      $('status-led').className = `inline-block w-2.5 h-2.5 rounded-full ${live ? 'bg-emerald-500' : 'bg-zinc-500'}`;
    };
    window.setStatus = setStatus;

    // UIè¡¨ç¤º/éè¡¨ç¤º
    let chromeVisible = true;
    const toggleChrome = (v) => {
      chromeVisible = (v !== undefined ? v : !chromeVisible);
      chrome.style.opacity = chromeVisible ? '1' : '0';
    };
    window.toggleChrome = toggleChrome;
    hitbox.addEventListener('click', () => toggleChrome());

    // ãƒœãƒˆãƒ ã‚·ãƒ¼ãƒˆé–‹é–‰
    const openSheet = () => { 
      sheet.style.opacity = '1'; 
      sheet.style.transform = 'translateY(0)'; 
      sheet.style.pointerEvents = 'auto';
      hitbox.style.pointerEvents = 'none'; 
    };
    const closeSheet = () => { 
      sheet.style.opacity = '0'; 
      sheet.style.transform = 'translateY(100%)'; 
      sheet.style.pointerEvents = 'none';
      hitbox.style.pointerEvents = ''; 
    };
    window.openSheet = openSheet;
    window.closeSheet = closeSheet;
    $('btn-more').addEventListener('click', openSheet);
    $('btn-close-sheet').addEventListener('click', closeSheet);

    // ãƒˆãƒ¼ã‚¹ãƒˆ
    const toast = (msg) => { 
      const toastEl = document.createElement('div');
      toastEl.className = 'fixed bottom-20 left-1/2 -translate-x-1/2 min-w-[220px] max-w-[90vw] px-4 py-2 rounded-xl bg-white/10 backdrop-blur text-sm shadow-2xl z-50';
      toastEl.textContent = msg;
      document.body.appendChild(toastEl); 
      setTimeout(()=>toastEl.remove(), 2500); 
    };
    window.toast = toast;

    // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥åŠ¹æœ
    window.showFlash = () => {
      flash.classList.remove('hidden');
      setTimeout(() => flash.classList.add('hidden'), 120);
    };

    // éŸ³å£°ãƒœã‚¿ãƒ³ï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨éŸ³å£°æœ‰åŠ¹åŒ–ï¼‰
    const btnSound = $('btn-sound');
    let soundEnabled = false;
    
    if (btnSound) {
      btnSound.addEventListener('click', () => {
        soundEnabled = !soundEnabled;
        
        if (soundEnabled) {
          if (window.enableSpeech) {
            window.enableSpeech();
          }
          toast('ğŸ”‰ éŸ³å£°ON');
          btnSound.querySelector('span').textContent = 'ğŸ”‰';
        } else {
          toast('ğŸ”‡ éŸ³å£°OFF');
          btnSound.querySelector('span').textContent = 'ğŸ”‡';
        }
      });
    }
    
    // åˆå›ã‚¿ãƒƒãƒ—ã§éŸ³å£°ã‚’æœ‰åŠ¹åŒ–
    document.addEventListener('click', () => {
      if (window.enableSpeech && !soundEnabled) {
        window.enableSpeech();
        soundEnabled = true;
        if (btnSound) {
          btnSound.querySelector('span').textContent = 'ğŸ”‰';
        }
      }
    }, { once: true });

    // ====== ãƒ¢ãƒã‚¤ãƒ«éŸ³å£°ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ï¼ˆæœ€åˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§ä¸€åº¦ã ã‘ï¼‰ ======
    let audioUnlocked = false;
    let ttsAudioEl = null;

    function ensureAudioEl() {
      if (!ttsAudioEl) {
        ttsAudioEl = document.createElement('audio');
        ttsAudioEl.id = 'tts';
        ttsAudioEl.playsInline = true;     // iOSå¿…é ˆ
        document.body.appendChild(ttsAudioEl);
      }
      return ttsAudioEl;
    }

    async function unlockAudioOnce() {
      if (audioUnlocked) return;
      try {
        // ç„¡éŸ³ã‚’çŸ­ãé³´ã‚‰ã—ã¦å†ç”Ÿè¨±å¯ã‚’å¾—ã‚‹ï¼ˆå¤±æ•—ã—ã¦ã‚‚OKï¼‰
        const a = ensureAudioEl();
        // 0.05ç§’ã®ç„¡éŸ³mp3ï¼ˆè¶…çŸ­ã„ãƒ‡ãƒ¼ã‚¿URIï¼‰
        a.src = 'data:audio/mpeg;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQAA';
        await a.play().catch(() => {});
      } finally {
        audioUnlocked = true;
      }
    }

    // æ—¢å­˜ãƒœã‚¿ãƒ³ã®æœ€åˆã®ã‚¯ãƒªãƒƒã‚¯ã§å¿…ãšå‘¼ã¶
    ['btn-start','btn-shutter','btn-capture','btn-rec','btn-audio-test'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('click', unlockAudioOnce, { once: true });
    });

    // TTS ã®å†ç”Ÿãƒ˜ãƒ«ãƒ‘ï¼ˆBlob/URLã©ã¡ã‚‰ã§ã‚‚ï¼‰
    async function playTTS(source) {
      const a = ensureAudioEl();
      a.src = source instanceof Blob ? URL.createObjectURL(source) : String(source);
      try {
        // canplay ã‚’å¾…ã¤ã¨å®‰å®š
        await new Promise(res => a.addEventListener('canplay', res, { once: true }));
        await a.play();
      } catch (err) {
        toast('å†ç”Ÿã«ã¯ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„');  // ã‚‚ã—æ‹’å¦ã•ã‚ŒãŸã‚‰æ¡ˆå†…
        throw err;
      }
    }
    window.playTTS = playTTS;
  </script>
  
  <!-- camera.jsèª­ã¿è¾¼ã¿ -->
  <script src="./camera.js"></script>
</body>
</html>